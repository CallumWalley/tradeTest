[gd_scene load_steps=13 format=2]

[ext_resource path="res://assets/icons/arrows/icon_down_default.tga" type="Texture" id=1]
[ext_resource path="res://assets/icons/arrows/icon_up_default.tga" type="Texture" id=2]
[ext_resource path="res://assets/icons/arrows/icon_down_disabled.tga" type="Texture" id=3]
[ext_resource path="res://assets/icons/arrows/icon_up_hover.tga" type="Texture" id=4]
[ext_resource path="res://assets/icons/arrows/button_20_20_reject.dds" type="Texture" id=5]
[ext_resource path="res://assets/icons/arrows/icon_down_hover.tga" type="Texture" id=6]
[ext_resource path="res://assets/icons/arrows/icon_up_disabled.tga" type="Texture" id=7]
[ext_resource path="res://GUI/Elements/UIResource.tscn" type="PackedScene" id=8]

[sub_resource type="CSharpScript" id=4]
script/source = "using Godot;
using System;
using System.Collections.Generic;

public class UITradeRoute : Control
{
	public TradeRoute tradeRoute;
	static readonly PackedScene resourceIcon = (PackedScene)GD.Load<PackedScene>(\"res://GUI/Components/UIResource.tscn\");

	public static PlayerTradeRoutes playerTradeRoutes;

	TextureButton moveUpButton;
	TextureButton moveDownButton;

	// Element to update on change.
	Control callback;

	public void Init(TradeRoute _tradeRoute){
		tradeRoute = _tradeRoute;
		//callback = _callback;

		// Add details panel.
		foreach (Resource r in tradeRoute.destination.GetStandard()){
			UIResource ui = resourceIcon.Instance<UIResource>();
			ui.Init(r);
			GetNode(\"Details\").AddChild(ui);
		}
		GetNode(\"Summary\").Connect(\"toggled\", this, \"ShowDetails\");

		// Set button text
		GetNode<Label>(\"Summary/AlignLeft/Source\").Text = $\"â†’ system - {tradeRoute.destination.GetParent<Body>().Name}\";
		UIResource freighterIcon = GetNode<UIResource>(\"Summary/AlignLeft/Freighters\");
		freighterIcon.Init(tradeRoute.tradeWeight);

		// Set reorder buttons
		moveUpButton = GetNode<TextureButton>(\"Summary/AlignRight/Reorder/MoveUp\");
		moveDownButton = GetNode<TextureButton>(\"Summary/AlignRight/Reorder/MoveDown\");
		moveUpButton.Connect(\"pressed\", this, \"ReorderUp\");
		moveDownButton.Connect(\"pressed\", this, \"ReorderDown\");

		// Set reorder buttons
		GetNode<TextureButton>(\"Summary/AlignRight/Cancel/\").Connect(\"pressed\", this, \"Remove\");
	}
	public override void _Ready(){
		base._Ready();
	}
	public override void _Draw()
	{	
		if (tradeRoute == null){return;}
		int index = tradeRoute.destination.GetTransformerTrade().tradeRoutes.IndexOf(tradeRoute);
		moveUpButton.Disabled = false;
		moveDownButton.Disabled = false;
		if (index == 0){
			moveUpButton.Disabled = true;
		}
		if (index == (tradeRoute.destination.GetTransformerTrade().tradeRoutes.Count-1)){
			moveDownButton.Disabled = true;
		}
	}

	public void ShowDetails(bool toggled){
		GetNode<Control>(\"Details\").Visible = toggled;
	}
	public void Remove(){
		GetNode<PlayerTradeRoutes>(\"/root/Global/Player/Trade/Routes\").DeregisterTradeRoute(tradeRoute);
		Control parent = GetParent<Control>();
		parent.RemoveChild(this);
		parent.Update();
		QueueFree();
	}

	public void ReorderUp(){
		tradeRoute.destination.MoveChild(tradeRoute, tradeRoute.GetIndex()-1);
		GetParent<Control>().Update();
	}
	public void ReorderDown(){
		tradeRoute.destination.MoveChild(tradeRoute, tradeRoute.GetIndex()+1);
		GetParent<Control>().Update();
	}
}
"

[sub_resource type="AtlasTexture" id=1]
flags = 7
atlas = ExtResource( 5 )
region = Rect2( -1, 1, 31, 28 )

[sub_resource type="AtlasTexture" id=2]
flags = 7
atlas = ExtResource( 5 )
region = Rect2( 30, 0, 30, 30 )

[sub_resource type="AtlasTexture" id=3]
flags = 7
atlas = ExtResource( 5 )
region = Rect2( 60, 0, 30, 30 )

[node name="TradeRoute" type="VBoxContainer"]
margin_right = 1023.0
margin_bottom = 30.0
size_flags_horizontal = 3
script = SubResource( 4 )

[node name="Summary" type="Button" parent="."]
margin_right = 1023.0
margin_bottom = 30.0
rect_min_size = Vector2( 0, 30 )
mouse_filter = 1
size_flags_horizontal = 3
toggle_mode = true
align = 0

[node name="AlignLeft" type="HBoxContainer" parent="Summary"]
margin_left = 10.0
margin_bottom = 30.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="Freighters" parent="Summary/AlignLeft" instance=ExtResource( 8 )]
anchor_left = 0.0
anchor_top = 0.0
anchor_right = 0.0
anchor_bottom = 0.0
margin_right = 30.0
margin_bottom = 30.0

[node name="VSeparator" type="VSeparator" parent="Summary/AlignLeft"]
modulate = Color( 0.4, 0.4, 0.4, 1 )
margin_left = 34.0
margin_right = 38.0
margin_bottom = 30.0

[node name="Source" type="Label" parent="Summary/AlignLeft"]
margin_left = 42.0
margin_right = 226.0
margin_bottom = 30.0
size_flags_horizontal = 0
size_flags_vertical = 1
text = "Some sysyem -> Some place"
valign = 1

[node name="AlignRight" type="HBoxContainer" parent="Summary"]
anchor_left = 1.0
anchor_right = 1.0
margin_left = -50.0
margin_bottom = 30.0
size_flags_horizontal = 3
size_flags_vertical = 3
alignment = 2

[node name="Reorder" type="VBoxContainer" parent="Summary/AlignRight"]
margin_left = 6.0
margin_right = 15.0
margin_bottom = 30.0
alignment = 1

[node name="MoveUp" type="TextureButton" parent="Summary/AlignRight/Reorder"]
margin_top = 7.0
margin_right = 9.0
margin_bottom = 13.0
texture_normal = ExtResource( 2 )
texture_hover = ExtResource( 4 )
texture_disabled = ExtResource( 7 )

[node name="MoveDown" type="TextureButton" parent="Summary/AlignRight/Reorder"]
margin_top = 17.0
margin_right = 9.0
margin_bottom = 23.0
texture_normal = ExtResource( 1 )
texture_hover = ExtResource( 6 )
texture_disabled = ExtResource( 3 )

[node name="Cancel" type="TextureButton" parent="Summary/AlignRight"]
margin_left = 19.0
margin_right = 50.0
margin_bottom = 28.0
grow_vertical = 2
size_flags_horizontal = 0
size_flags_vertical = 0
texture_normal = SubResource( 1 )
texture_pressed = SubResource( 2 )
texture_hover = SubResource( 3 )

[node name="Details" type="HBoxContainer" parent="."]
visible = false
margin_top = 34.0
margin_right = 1024.0
margin_bottom = 34.0
alignment = 2
